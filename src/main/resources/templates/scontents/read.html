<!DOCTYPE html> 

<html layout:decorate="~{layout}"> <!-- layout.html 상속-->
<div layout:fragment="content">
			<script>
					let reply_data; // 댓글 500건 저장
					let reply_now_page=1; // 댓글 현재 페이지
			</script>
			
       <script>
       window.onload=() =>{
					let content_tag=document.getElementById('content');
					let btn_create_tag=document.getElementById('btn_create'); //등록
					let btn_add_tag = document.getElementById("btn_add"); //더보기
					let scmt_date_tag = document.getElementById("scmt_date");

					
					let reply_list_tag = document.getElementById("reply_list"); //목록 출력
					let scmt_no_tag = document.getElementById("scmt_no");
					let acc_no_tag = document.getElementById("acc_no");
					
					let btn_save_tag=document.getElementById("btn_save");
					let btn_delete_tag = document.getElementById("btn_delete");
					
					content_tag.addEventListener('click',() =>{
						let id = '[[${session.acc_id}]]'; //jaxascript -> thymeleaf -> session
						//alert('Click!: ' +id);
						if(id==''){
							alert('로그인해야 댓글을 입력 할 수 있습니다.');
							location.href="/account/login?url=/scontents/read?cate_no=1%26scon_no=[[${scontentsVO.scon_no}]]%26word=[[${word}]]%26now_page=[[${now_page}]] ";
							
						}else{
							//alert('로그인 됨');
							//content_tag.focus();
						}
					});
					
					btn_create_tag.addEventListener('click',() =>{
					let content = content_tag.value.trim();
						if(content.length == 0){
							alert('내용이 없습니다. 내용을 입력해주세요.');
						}else{
							// {"sentence":"안녕하세요.","language":"영어","age":"25"}
					        // console.log(JSON.stringify({sentence, language, age}))
					        // return;
					        //
					        fetch("/reply/create",{
		                  "method": "post", 
		                  "headers": {"Content-Type": "application/json"},
					        	body:JSON.stringify({"scon_no":"[[${scontentsVO.scon_no}]]","scmt_comment":content})
					        })
					        .then((response) => response.json())
					        .then((data) =>{
					        	list_by_contents_join()
					        });
					        //result_animation_tag.innerHTML = '<img src="/static/images/progress.gif" style="width: 15%; margin-top: 0px;">';
						}
					});
					//페이징 처리
					btn_add_tag.addEventListener('click',()=>{ //더보기 출력

						//console.log(reply_data.length)
						if(reply_data.length>reply_now_page*5){
							//console.log("들어옴")
							let start = 0;
							let end = 0;
							if(reply_data.length>5){
								start = reply_now_page *5;
								end = (reply_now_page *5 ) +5;
								
								let msg = "";
								let page_div = document.createElement('div');
								
						    	   fetch("/reply/list_by_contentsno_join?scon_no=[[${scontentsVO.scon_no}]]&acc_no=[[${session.acc_no}]]",{
						    		   "method":"get"
						    	   })
						    	   .then((response) => response.json())
						    	   .then((data) => {
						    		   reply_data=data['res'];
												for(let i = start;i<end;i++){
													if(i==reply_data.length){
														break;
													}
				    			   			 let row = reply_data[i];
					   	             msg += "<div id='"+row.scmt_no+"' style='border-bottom: solid 1px #EEEEEE; margin-bottom: 10px;'>";
					   	             msg += "<span style='font-weight: bold;'>" + row.acc_id + "</span><br>";
					   	          	 msg += "<br>";
					   	          	 msg += " "+row.scmt_date;
					   	          	 
						   	          msg += "<span>";

							   	       msg += "</span>";

					    	             if("[[${session.acc_no}]]" == row.acc_no){
					    	                 msg += " <a href='javascript:reply_update("+row.scmt_no+")'>수정</a>";
					    	                 msg +="<span class='menu_divide' >│</span>"
					    	                 msg += "  <a href='javascript:reply_delete("+row.scmt_no+")'>삭제</a>";
					    	             }
				    	             msg += " " + "<br>";
				    	             msg += row.scmt_comment;
				    	             msg += "</div>";
												}
				                 page_div.innerHTML = msg; //  페이지에 속한 레코드들 추가
				                 reply_list_tag.appendChild(page_div);
				                 
				                 reply_now_page = reply_now_page + 1;
											});
							}
						}
						
					});
					
						btn_save_tag.addEventListener('click',()=>{
							let scmt_no = scmt_no_tag.value;
							let content = content_tag.value;
							let acc_no = acc_no_tag.value;
								
								if(content.length ==0){
									alert("내용이 없습니다. 내용을 입력해주세요")
								}else{
									fetch("/reply/update",{
										 "method": "post", 
		                  "headers": {"Content-Type": "application/json"},
		                  body: JSON.stringify({"acc_no": acc_no, "scmt_no": scmt_no, "scmt_comment": content})
									})
									.then((response) => response.json())
									.then((data) =>{
										if(data['res']==0){
											alert("댓글 수정에 실패했습니다. 잠시후 다시 시도해 주세요")
										}else{
											list_by_contents_join()
											content_tag.value="";
											content_tag.focus();
											btn_visible('default');
											
										}
									});
								}
						
					});

						list_by_contents_join();
       } // window.onload END

       function list_by_contents_join(){
    	   let cnt = 0 //출력 순환 횟수
    	   fetch("/reply/list_by_contentsno_join?scon_no=[[${scontentsVO.scon_no}]]&acc_no=[[${session.acc_no}]]",{
    		   "method":"get"
    	   })
    	   .then((response) => response.json())
    	   .then((data) => {
    		   reply_data=data['res'];
    		   if(reply_data.length>5){
    			   cnt=5;
    		   }else{
    			   cnt = reply_data.length;
    		   }
    		   let msg ="";
    		   for(let i = 0;i<cnt;i++){
		   			 let row = reply_data[i];

 	             msg += "<div id='"+row.scmt_no+"' style='border-bottom: solid 1px #EEEEEE; margin-bottom: 10px;'>";
 	             msg += "<span style='font-weight: bold;'>" + row.acc_id + "</span><br>";
 	          	 msg += " "+row.scmt_date;

	   	          	 
    	             if("[[${session.acc_no}]]" == row.acc_no){
    	                 msg += " <a href='javascript:reply_update("+row.scmt_no+")'>수정</a>";
    	                 msg +="<span class='menu_divide' >│</span>"
    	                 msg += "  <a href='javascript:reply_delete("+row.scmt_no+")'>삭제</a>";
    	             }

    	             msg += " " + "<br>";
    	             msg += row.scmt_comment;
    	             msg += "</div>";
    		   }

    		   document.getElementById("reply_list").innerHTML = msg;
    	   });
       }
       
       function reply_delete(scmt_no){
    	   let content_tag = document.getElementById("content");
    	   fetch("/reply/read?scmt_no=" + scmt_no,{
    		   "method":"get",
    		   "headers": {"Content-Type": "application/json"},
    	   })
    	   .then((response) =>response.json())
    	   .then((data)=>{
    		   let sw = confirm("「" + data['res']['scmt_comment'] + "」 삭제하시려면 확인 버튼을 누르세요. 삭제후 복구 할 수 없습니다." );
    		   if(sw==true){
    			   
    			   fetch("/reply/delete",{
    			   "method":"POST",
    			   "headers": {"Content-Type": "application/json"},
    			   body: JSON.stringify({"scmt_no": scmt_no, "acc_no": data['res']['acc_no']})
    			  
    		   })
    		   .then((response) =>response.json())
    		   .then((data) =>{
    			   if(data['res'] ==1){
    				   console.log("삭제 성공")
    				   list_by_contents_join();
    				   content_tag.value="";
    				   content_tag.focus();
    			   }else{
    				   alert("댓글 삭제에 실패했습니다. 잠시 후 다시 시도해주세요.")
    			   }
    		   });
    	   }else{
    		   alert("삭제를 취소 했습니다.");
    		   }
    	   });
       }
       
       //수정폼
       function reply_update(scmt_no){
    	   let scmt_no_tag = document.getElementById("scmt_no")
    	   let acc_no_tag = document.getElementById("acc_no")
    	   let content_tag = document.getElementById("content");
    	   
    	   fetch("/reply/read?scmt_no=" + scmt_no,{
    		   "method":"GET",
    		   "headers": {"Content-Type": "application/json"},
    	   })
    	   .then((response) => response.json())
    	   .then((data)=>{
    		   scmt_no_tag.value=data['res']['scmt_no'];
    		   acc_no_tag.value=data['res']['acc_no']
    		   content_tag.value=data['res']['scmt_comment']
    		   content_tag.focus();
    		   btn_visible('update');
    	   });
    	   
       }
       function reply_cancel(scmt_no){
    	   fetch("/reply/like_cancel",{
    		   "method":"POST",
    		   "headers":{"Content-Type":"application/json"},
    		   body: JSON.stringify({"scon_no":"[[${scontentsVO.scon_no}]]","scmt_no": scmt_no, "acc_no": "[[${session.acc_no}]]"})
    	   })
    	   .then((response) =>response.json())
    	   .then((data)=>{
    		   console.log(data['cnt'])
    		   if(reply_now_page>1){
    			   console.log("더보기 필요함");
    			   console.log(reply_now_page);
    		   }
    		   list_by_contents_join();
    	   })
       }
       
       function reply_like(scmt_no){
    	   let acc_no_tag = document.getElementById("acc_no");
    	   let scmt_no_tag = document.getElementById("scmt_no")
    	   fetch("/reply/like",{
    		   "method":"POST",
    		   "headers":{"Content-Type":"application/json"},
    		   body: JSON.stringify({"scon_no":"[[${scontentsVO.scon_no}]]","scmt_no": scmt_no, "acc_no": "[[${session.acc_no}]]"})
    	   })
    	   .then((response) =>response.json())
    	   .then((data)=>{
    		   console.log(data['cnt'])
    		   if(reply_now_page>1){
    			   console.log("더보기 필요함");
    			   console.log(reply_now_page);
    		   }
    		   list_by_contents_join();
    	   });
       }
       
       function btn_visible(sw){
           let btn_create =document.getElementById("btn_create");
           let btn_save =document.getElementById("btn_save");
           let btn_cancel =document.getElementById("btn_cancel");
           
           if(sw=='update'){
        	   btn_create.style.display='none';
        	   btn_save.style.display='';
        	   btn_cancel.style.display=''
           }else if(sw=='default'){
              btn_create.style.display=''; 
              btn_save.style.display='none';
              btn_cancel.style.display='none';
           }
       }
       

					</script>
  
    <script>

    function mark(){
    	console.log("mark  클릭");
    	let scon_no = document.getElementById("scon_no").value;
    	let cate_no = 1;
    	
    	let url;
    	let currentImg = document.getElementById("bookmarkImage").src;
    	
    	if(currentImg.endsWith("bookmark_off.png")){
    		url = './up_priority/'+scon_no+'?cate_no=' +cate_no;
    	}else{
    		url='./down_priority/'+scon_no+'?cate_no=' +cate_no;
    	}
  
    	fetch(url,{
    		method:'GET',
    	})
    	.then(response =>response.json())
    	.then(rdata=>{
    		if(rdata.cnt==0){
    			alert("로그인이 필요합니다.");
    			return;
    		}
    		if(rdata.cnt>0){
    			//console.log("우선순위 변경 선공");
    			if(currentImg.endsWith("bookmark_off.png")){
    				document.getElementById("bookmarkImage").src = "/css/images/bookmark_on.png";
    				alert("찜하기에 등록했어요!");
    			}else{
    				document.getElementById("bookmarkImage").src = "/css/images/bookmark_off.png";
    			}
    		}
    	})
    	.catch(error =>{
    		console.log('Error:',error);
    	});
    }
    function confirmUpdate(member_no, acc_no, scon_no,cate_no){
    	if(member_no != acc_no){
    		alert("권한이 필요합니다.");
    		return false;
    	}
    	const url = `./update_text/${member_no}?scon_no=${scon_no}&cate_no=${cate_no}`;
    	window.location.href=url;
    	return true;
    }
    
    function confirmDelete(member_no, acc_no, scon_no,cate_no){
    	if(member_no != acc_no){
    		alert("권한이 필요합니다.");
    		return false;
    	}
    	const url = `./delete/${member_no}?scon_no=${scon_no}&cate_no=${cate_no}`;
    	window.location.href=url;
    	return true;
    }
    
    function confirmFile(member_no, acc_no, scon_no,cate_no){
    	if(member_no != acc_no){
    		alert("권한이 필요합니다.");
    		return false;
    	}
    	const url = `./update_file/${member_no}?scon_no=${scon_no}&cate_no=${cate_no}`;
    	window.location.href=url;
    	return true;
    }
    

  </script>

  <div class='title_line'>
    <span th:text="${scontentsVO.scon_title}" class="title_line_text"></span > 
    > 글 조회
  </div>
  
  <aside class="aside_right" >
    <a href="./create?cate_no=1">등록</a>
    <span class='menu_divide' >│</span>
    <a href="#" th:attr="onclick=|return confirmUpdate(${member_no}, '${acc_no}', ${scontentsVO.scon_no}, 1)|">글수정</a>
    <span class='menu_divide' >│</span>
       <a href="#" th:attr="onclick=|return confirmFile(${member_no}, '${acc_no}', ${scontentsVO.scon_no}, 1)|">파일수정</a>
    <span class='menu_divide' >│</span>    
    <a href="#" th:attr="onclick=|return confirmDelete(${member_no}, '${acc_no}', ${scontentsVO.scon_no}, 1)|">삭제</a>
    <span class='menu_divide' >│</span>


    <a href="javascript:location.reload();">새로고침</a>

  </aside> 

  <div class='menu_line'></div>

  <fieldset class="fieldset_basic">
    <ul>
    <div>
      <li class="li_none">
        <div style="width: 100%; word-break: break-all;">

<div style='margin: 0px auto; width: 900px;'>

    <br>
    <div style="display:flex; align-items: center; margin-left:90px; flex-direction:row; justify-content: space-between;" > 
    	<span th:text="${scontentsVO.scon_title}" style="font-size:2em;font-weight: bold;"></span>
    	<span style="font-size: 1em; margin-left:10px;" th:text="|조회수: ${scontentsVO.scon_views}|"></span>
    		<div style="margin-left: auto; margin-right:86px;">
    			<span style="font-size: normal; margin-left:1px;" th:text="${scontentsVO.scon_date}"></span>
    			    		 <span th:if="${scontentsVO.mark =='N'}">
            <img src="/css/images/bookmark_off.png" id="bookmarkImage" class="icon" onclick="mark()" style="width:24px; height: 24px;">
        </span>
        <span  th:unless="${scontentsVO.mark =='N'}">
            <img src="/css/images/bookmark_on.png" id="bookmarkImage" class="icon" onclick="mark()" style="width:24px; height: 24px;">
        </span>
    		</div>

    </div>
    <hr size="10;" style="height: 10px; ">
    <!-- 
     <div style="float:right; ">
        <span th:if="${scontentsVO.mark =='N'}">
            <img src="/css/images/bookmark_off.png" id="bookmarkImage" class="icon" onclick="mark()" style="width:24px; height: 24px;">
        </span>
        <span th:unless="${scontentsVO.mark =='N'}">
            <img src="/css/images/bookmark_on.png" id="bookmarkImage" class="icon" onclick="mark()" style="width:24px; height: 24px;">
        </span>
    </div> -->


      <div class="fotorama" data-autoplay="5000" data-nav="thumbs" data-ratio="800/520" style='display: flex; justify-content: center; align-items: center; width: 100%;'>
        <img th:src="@{|/contents/storage/${share_imageVO.file_thumb_name}|}"  th:each="share_imageVO, status: ${share_imageVO}"
                th:if="${share_imageVO.file_origin_name.endsWith('jpg') or share_imageVO.file_origin_name.endsWith('png') or share_imageVO.file_origin_name.endsWith('gif')}">
                   
                </div>


    <br>
    
		<div class ="horizontal-container">
   		<tr th:each="item, status : ${list2}">
   			<div class='read_hashtag' style = "padding:5px">
        	<td>
            	#<span th:text="${item.tag_name}" class="bold;"></span>
        	</td>
      	</div>
    	</tr>
    </div>


					<div style="text-align:left; margin-top:5px;" >
					<span style="font-size: 1.5em; font-weight: normal;" th:text="${scontentsVO.scon_contents}"></span><br>
					          <div style="white-space: pre-wrap;"></div>
          </div>
          <input type="hidden" id="scon_no" name="scon_no" th:value="${scontentsVO.scon_no}">
          <input type="hidden" id="acc_id" name="acc_id" th:value="${session.acc_id}">
				<br>
		
<div style="display:flex; flex-direction:row; justify-content: space-between;">
    <div>
        <span style="font-size:1.5em">데스크 제품 목록</span>
        
        <br>
        <a style="font-size: 1em;" th:href="${url_list0}" th:text="${url_list0}" th:if="${url_list0 != '1'}" >Link1</a><br>
        <a style="font-size: 1em;" th:href="${url_list1}" th:text="${url_list1}" th:if="${url_list1 != '1'}">Link2</a><br>
        <a style="font-size: 1em;" th:href="${url_list2}" th:text="${url_list2}"  th:if="${url_list2 != '1'}">Link3</a><br>
        <a style="font-size: 1em;" th:href="${url_list3}" th:text="${url_list3}"   th:if="${url_list3 != '1'}">Link4</a><br>
        <a style="font-size: 1em;" th:href="${url_list4}" th:text="${url_list4}"  th:if="${url_list4 != '1'}">Link5</a>
    </div>
</div>
			<br><br>
			 
			  <div style='width: 80%; margin: 0px auto; clear:both; text-align:center;'>
			 <div style="float:left;">댓글수: <span th:text="${count}"></span></div><br>
			     <hr>  
			      <form name='frm_reply' id='frm_reply'> 
			          <input type='hidden' name='scon_no' id='scon_no' value='${scontentsVO.scon_no}'>
			          <input type='hidden' name='acc_no' id='acc_no' value=''>
			          <input type='hidden' name='scmt_no' id='scmt_no' value=''>
			          
			          <textarea name='content'  class='form-control' id='content' style='width: 100%;  height: 60px;' 
			          							placeholder="댓글 작성, 로그인해야 등록 할 수 있습니다." autofocus='autofocus'></textarea>
			          <div style='text-align: center;'> 
			          <br>
      					 <button type='button' id='btn_create'>  등  록  </button>
                 <button type='button' id='btn_save' style='display: none;'>  저  장  </button>
                 <button type='button' id='btn_delete' style='display: none;'>  삭  제  </button>
                 <button type='button' id='btn_cancel' style='display: none;'>  취  소  </button>
               </div>               
			      </form>
			      <hr>
			      <div id='reply_list' data-replypage='1'>  
			      등록된 댓글이 없습니다.
			      </div>
			      <div id='reply_list_btn' style='border:none;'>
			          <button id='btn_add' style='width: 100%;'>더보기 ▽</button>
			      </div>  
			  </div>
    

</div>
    </div>
    </div>
      </li>

      </div>
    </ul>
    <br>
  </fieldset>


    <span id='id_msg'></span>  

</div>

</html>